config:
  threads: 100
  loop: 10

default:
  follow_redirects: false
  headers:
    user-agent: Mozilla/5.0 (Windows NT 6.1; rv:45.0) Gecko/20100101 Firefox/45.0
    accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
    accept-language: en-US,en;q=0.5
    accept-encoding: gzip, deflate
  timeout: 15

vars:
  host: https://www.example.com

inputs:
  - source: test/in.csv
    adapter: csv
  - source: test/proxies.txt
    adapter: txt
    as: proxies

output:
  adapter: csv
  source: test/testout.csv

before:
  - get:
      url: http://icanhazip.com
  - extract:
      regex: '.*'
      as: ip

tasks:
  - get:
      url: {{ .Vars.host }}
      success:
        when: '{{ .Page.Status == 200 }}'
  - extract:
      regex: 'csrf_token="(.*)"'
      as: csrf_token
  - post:
      url: '{{ Vars.host }}/login'
      headers:
        referer: http://www.example.com
      params:
        email: $login
        password: $password
      cookies:
        _token: $csrf_token
      success:
        when: '{{ .Page.Status == 301 }}'
      abort:
        when: '{{ .Page.Status == 500 }}'
      retry:
        when: '{{ .Page.Url | .Contains "/banned" }}'
        with: '.Proxies.Next'
        limit: 5
      fail:
        when: '.Page.Body.Match "User .* not found"'
  - extract:
      element: "div.user>span.id"
      as: user_id
  - get:
      url: https://www.example.com/account
      success: '.Page.Title == "Account"'

finally:
  - post:
      url: http://www.example.com/webhook/success/{{.Uid}}
      when: '.Success'

